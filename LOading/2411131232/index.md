---
layout: post
type: LOading
date: 2024-11-13 12:32
category: 개발
title: Lambda vs RabbitMQ
subtitle: 함수 대 토끼
writer: 0
post-header: true
header-img: ../aws.jpeg
hash-tag:
  - 술
  - AWS
  - Lambda
  - RabbitMQ
---


# Intro
---
지금 프로젝트에서 `어떤 아키텍쳐를 가져갈 것인가`에 대한 결정을 해야 한다.
필요한 역활은 이미지 정보를 AI서버에 보내서 결과를 받은후 그 결과를 DB에 저장 해야 하는 역활이다.
기존의 Demo 버전에서는 Redis + Celery를 활용하여 처리 하였다.
Beta 버전에서는 Lambda 혹은 RabbitMQ를 고려하고 있다.

<br>

# 지금 상황
---
- GenAI server에 generated img 를 요청해야 함
- generated time이 짧은 모델은 4초, 긴 모델은 10분이 소요됨

<br>


# Lambda

AWS Lambda는 서버리스 컴퓨팅 서비스로, 이벤트가 발생할 때 자동으로 코드를 실행하는 방식으로 작동합니다. 사용자는 코드를 준비하고 업로드하기만 하면, Lambda가 인프라 관리와 확장을 자동으로 처리해 주므로, 특정 이벤트에 반응하여 빠르게 작업을 수행할 수 있습니다.

<br>


### Lambda의 특장점

1. **서버리스**:
    
    - 서버 관리가 전혀 필요 없고, AWS가 모든 인프라를 관리해 주므로 개발자는 코드 작성과 기능 개발에 집중할 수 있습니다.
    - 서버 프로비저닝이나 유지보수 작업을 생략할 수 있어 관리 부담이 줄어듭니다.
2. **자동 확장성**:
    
    - Lambda는 트래픽의 급증이나 감소에 따라 자동으로 확장하여 요청을 처리합니다.
    - 트래픽이 증가하면 별도의 인스턴스를 자동으로 할당하여 여러 요청을 병렬로 처리할 수 있습니다.
3. **이벤트 기반 트리거**:
    
    - AWS 내 다양한 서비스(S3, DynamoDB, SNS, API Gateway 등)와 통합되어 이벤트 기반으로 동작할 수 있습니다.
    - 이를 통해 특정 이벤트가 발생할 때만 Lambda를 트리거할 수 있어 유연한 워크플로우 구성이 가능합니다.
4. **비용 효율성**:
    
    - 사용한 만큼만 비용을 지불하는 방식으로, 코드가 실행될 때만 비용이 발생합니다.
    - 이벤트 기반으로 짧고 간헐적으로 실행되는 작업에 특히 비용 효율적입니다.
5. **고성능 및 짧은 실행 시간**:
    
    - Lambda는 고성능 컴퓨팅 자원을 활용할 수 있으며, 최대 15분까지의 짧은 실행 시간 제한이 있어 신속하게 응답해야 하는 애플리케이션에 적합합니다.
6. **환경 설정 및 보안**:
    
    - 다양한 메모리 크기와 타임아웃을 선택하여 필요에 맞게 Lambda를 설정할 수 있으며, 환경 변수와 IAM 역할을 통해 보안 설정도 가능하여 안전하게 관리할 수 있습니다.

<br>


### Lambda의 활용 사례
Lambda는 서버리스 환경에서 요청에 따라 동적으로 확장되는 구조이므로, 이미지 정보 수신부터 AI 서버 요청, S3 업로드, DB 저장까지의 단계를 이벤트 기반으로 관리하기에 적합할 수 있습니다.

1. **파일 처리**:
    
    - 이미지, 비디오, PDF 등의 파일 업로드 시 S3 이벤트를 통해 Lambda가 트리거되어 자동으로 파일을 처리(크기 조정, 포맷 변환 등)하고 결과를 저장합니다.
    - 예: 사용자가 이미지를 업로드하면 Lambda가 자동으로 썸네일을 생성해 S3에 저장.
2. **백엔드 API**:
    
    - AWS API Gateway와 함께 사용하여 서버리스 REST API를 구현할 수 있습니다.
    - 예: 쇼핑몰 API에서 제품 정보 제공, 주문 처리 등과 같은 트랜잭션 작업을 수행.
3. **데이터 스트리밍 및 ETL**:
    
    - DynamoDB Streams나 Kinesis 데이터 스트림을 사용해 실시간 데이터를 수집하고 분석하거나, 데이터 변환 작업을 수행합니다.
    - 예: 실시간 로그 수집 시스템에서 로그 데이터를 DynamoDB나 S3에 저장하고 분석.
4. **스케줄 기반 작업**:
    
    - AWS CloudWatch Events와 통합하여 특정 시간이나 주기마다 작업을 실행하는 스케줄 작업을 설정할 수 있습니다.
    - 예: 매일 자정에 데이터베이스 백업을 자동화하거나 정기 리포트를 생성하여 이메일로 전송.
5. **알림 및 메시징**:
    
    - SNS, SQS와 통합하여 특정 조건에 따라 알림을 보내거나 메시지 큐에 전달하는 기능을 구현할 수 있습니다.
    - 예: 서버 장애가 발생할 때 자동으로 알림을 발송하거나 메시지 큐에서 작업을 받아 처리.
6. **IoT 데이터 처리**:
    
    - AWS IoT Core와 통합하여 IoT 장비에서 수집한 데이터를 처리하고, 이를 통해 장비 상태를 모니터링하거나 이상 감지를 수행할 수 있습니다.
    - 예: 온도 센서 데이터를 실시간으로 모니터링하여 특정 범위를 벗어나면 경고 알림을 발송.

<br>


### Lambda 활용 시 고려 사항

- **실행 시간**: Lambda는 최대 실행 시간이 15분으로 제한되어 있으므로, 긴 실행 시간이 필요한 작업에는 적합하지 않습니다.
- **상태 유지 어려움**: Lambda는 상태가 없는(stateless) 실행 환경이므로, 상태 유지를 위해서는 외부 데이터베이스나 저장소를 활용해야 합니다.
- **동시 실행 한도**: 기본적으로 AWS 계정 및 리전별 동시 실행 한도가 있으므로, 대규모 트래픽 환경에서는 한도 관리를 해야 합니다.

<br>


### 요약

AWS Lambda는 서버리스, 이벤트 기반 컴퓨팅을 위한 매우 유연한 서비스로, 파일 처리, 실시간 데이터 스트리밍, 알림 시스템, API 백엔드, 정기 작업에 적합합니다. 서버 관리와 확장성 문제를 해결해 주기 때문에 서버리스 아키텍처에서 중요한 역할을 합니다.

- **장점**:
    
    - **서버리스**: Lambda는 서버 관리가 필요 없고, 요청 수에 따라 자동으로 확장됩니다. 트래픽 변동이 클 때도 대응이 가능하므로, 동시 요청이 많을 때도 비용 효율적입니다.
    - **AWS 서비스와의 통합**: Lambda는 S3, DynamoDB, RDS 등 다른 AWS 서비스와 손쉽게 통합할 수 있어, 이미지 업로드 후 DB에 URL 저장 작업이 자연스럽게 이어집니다.
    - **비용 절감**: 이미지 생성, 업로드, DB 저장 과정이 짧게 끝난다면 요청 건수에 비례한 비용만 청구되어 유리합니다.
- **단점**:
    
    - **실행 시간 제한**: Lambda는 15분 실행 제한이 있어, AI 서버 응답 시간이 길어질 경우 문제가 될 수 있습니다.
    - **API 호출 제한**: AWS Lambda는 API 호출 속도에 제한이 있어, AI 서버와의 통신 속도가 매우 높아야 할 경우 처리에 지연이 생길 수 있습니다.


# RabbitMQ

https://kim-link.github.io/LOading/2206021848/

<br>


### RabbitMQ 활용

RabbitMQ는 메시지 브로커 역할로 고속으로 요청을 분산 및 처리할 수 있습니다. 특히 여러 단계가 비동기적으로 작동할 때 유리합니다.

- **장점**:
    
    - **고속 메시지 처리**: 요청량이 많을 때 RabbitMQ는 메시지를 신속하게 분배하고 관리할 수 있습니다. 이 경우, 이미지 정보를 RabbitMQ 큐에 저장하고, 워커 프로세스를 통해 각 단계(AI 서버 요청, S3 업로드, DB 저장)를 비동기적으로 처리하는 구조를 만들 수 있습니다.
    - **안정성 및 유연성**: 재시도 기능, 메시지 누락 방지 등 신뢰성이 높은 메시징이 가능하며, 다양한 구성으로 동시 요청 처리 성능을 최적화할 수 있습니다.
    - **유연한 라우팅**: 메시지 큐에 따라 AI 서버 요청과 S3 업로드 단계를 분리하거나, 우선 순위를 조정할 수 있습니다.
- **단점**:
    
    - **운영 부담**: RabbitMQ는 서버 관리가 필요하고, 특히 고가용성 구성을 위해 클러스터링 및 모니터링 설정이 필요합니다.
    - **AWS 서비스와의 통합**: AWS Lambda와 달리 RabbitMQ는 AWS 서비스와의 직접 통합이 불가능하므로 추가적인 관리가 필요합니다.

<br>


### 추천 방안

1. **Lambda**: 요청 수가 아주 많지 않고, AWS 환경에서 서버 관리 부담 없이 작업을 진행하고자 한다면 Lambda가 적합합니다. AI 서버의 응답 시간이 제한 시간 내에 가능하고, AWS 서비스와의 통합이 중요한 경우 Lambda가 더 간단하고 비용 효율적입니다.
    
2. **RabbitMQ + 워커 프로세스**: 동시에 매우 많은 요청이 들어오고, 단계별 비동기 처리가 필요할 경우 RabbitMQ를 통해 메시지를 분배하고 각 워커에서 AI 서버 호출, S3 업로드, DB 저장을 병렬적으로 처리하는 방법이 좋습니다. 이 구조는 높은 트래픽을 효율적으로 처리할 수 있고, 각 단계의 분리가 가능합니다.
    

동시 요청이 많은 환경이라면 **RabbitMQ**가 유리할 수 있지만, 간단한 관리와 AWS 내 자동 확장을 중시한다면 **Lambda**가 적합할 것입니다.


<br>

# Outro
---
결론적으로 지금 상황에 맞는 것은 RabbitMQ로 판단이 된다.
둘다 병렬 처리가 가능하지만 추후 유료 서비스로 전환 되었을때 가장 중요한게 메시지의 안정성이다.
다소 운영적 부담이 발생하지만 AI 서버에서 얼마나 빠르게 이미지를 생성해 줄지 가늠할수 없기 때문에 Lambda 사용 보다는 RabbitMQ 사용이 더 적합해 보인다.

<br>
